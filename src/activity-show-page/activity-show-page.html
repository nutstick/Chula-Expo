<!-- Libery -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Web Component -->
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../../bower_components/paper-tags-input/paper-tags-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/greenyouse-datetime-local-input/datetime-local-input.html">
<link rel="import" href="../../bower_components/google-map/google-map.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/google-map/google-map-marker.html">

<link rel="import" href="../activity-api/activity-api.html">
<link rel="import" href="../place-api/place-api.html">
<link rel="import" href="../zone-api/zone-api.html">
<link rel="import" href="../room-api/room-api.html">
<link rel="import" href="../bottom-prefab-speed-dial/bottom-prefab-speed-dial.html">
<link rel="import" href="../paper-card-dataitem/paper-card-dataitem.html">
<link rel="import" href="../shared-styles/shared-styles.html">
<link rel="import" href="../rounds-list/rounds-list.html">
<link rel="import" href="../qr-scanner/qr-scanner.html">
<link rel="import" href="../activity-check-list/activity-check-list.html">

<dom-module id="activity-show-page">
  <template>
		<style is="custom-style" include="shared-styles">
      :host {
        @apply(--layout-vertical);
        @apply(--layout-center-center);
        padding-top: 20px;
				margin-bottom: 40px;
      }

			paper-card {
        width: 100%;
      }

      .item {
        margin-bottom: 10px;
      }

      .avatar {
        display: inline-block;
        height: 40px;
        overflow: hidden;
        margin-right: 20px;
      }

      .flex-layout {
        @apply(--layout-horizontal);
      }
      .flex {
        @apply(--layout-flex);
      }
      .label {
        font-weight: 200;
        width: 100px;
        display: inline-block;
        margin-right: 20px;
      }
      .label.upload {
        line-height: 70px;
      }

      .company {
        font-size: 20px;
        font-weight: 200;
      }
      google-map {
        height: 300px;
      }
      .google-map {
        display: block;
        height: 300px;
      }

			.button-holder {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        margin-top: 10px;
      }

			#main {
        min-height: 800px;
        margin: 0px;
        padding: 0px;
        display: flex;
        flex-flow: row;
			}

			#main > #left {
				margin: 4px;
				flex: 3 1 70%;
        min-width: 70%;
				order: 1;
			}

			#main > #right {
				flex: 3 1 30%;
        min-width: 30%;
				order: 2;
			}

      .card {
        margin: 4px;
        padding: 5px;
      }

			/* Too narrow to support three columns */
			@media all and (max-width: 800px) {
					#main {
							flex-direction: column;
					}

					#main > #left, #main > #right {
					/* Return them to document order */
							order: 0;
					}

					#main > #left, #main > #right {
							min-height: 50px;
					}
			}

      paper-button > a {
        color: #000;
        text-decoration: none;
        width: 100%;
      }

      .block {
        margin: 10px;
      }

      .deleteBtn {
        float: right;
        cursor: pointer;
      }

      .fitdiv {
        display: inline;
        word-wrap: break-word;
      }
      #activityCheckDialog {
        width: 100%;
      }
    </style>
    <activity-api
			id="activityAPI"
			activity-id="{{activityId}}"
			fields=""
			page="0"
			page-size="0"
			activity="{{activity}}"
    ></activity-api>
		<div id="main" class="container">
			<paper-card id="left">
        <div class="card-content">
          <!-- Thumbnail Upload -->
					<div class="item">
						<div class="flex-layout">
							<label class="label upload">Thumbnail</label>
							<div class="flex">
                <iron-image style="width:140px; height:80px;" sizing="cover" preload fade src="{{_computeThumbnail(activity.thumbnail)}}"></iron-image>
							</div>
						</div>
					</div>
					<!-- Banner Upload -->
					<div class="item">
						<div class="flex-layout">
							<label class="label upload">Banner</label>
							<div class="flex">
                <iron-image style="width:200px; height:150px;" sizing="cover" preload fade src="{{_computeBanner(activity.banner)}}"></iron-image>
							</div>
						</div>
					</div>
					<!-- Time -->
					<div class="item">
						<div>
							<label class="label --input">Start Time</label>
							<div class="flex fitdiv">
								{{_convertToDate(activity.start)}}
							</div>
						</div>
						<div>
							<label class="label --input">End Time</label>
							<div class="flex fitdiv">
								{{_convertToDate(activity.end)}}
							</div>
						</div>
					</div>

					<div class="item">
						<div>
							<label class="label --input">Contact</label>
							<div class="flex fitdiv">
								{{activity.contact}}
							</div>
						</div>
					</div>

					<div class="item">
						<div>
							<label class="label --input">Video Url</label>
							<div class="flex fitdiv">
								{{activity.video}}
                <div id="qrvideo" style="width:250px; height:250px; margin-bottom:15px; margin-top:4px;"></div>

							</div>
						</div>
						<div>
							<label class="label input">PDF Url</label>
							<div class="flex fitdiv">
								{{activity.pdf}}
                <div id="qrcode" style="width:250px; height:250px; margin-bottom:15px; margin-top:4px;"></div>
							</div>
						</div>
						<div>
							<label class="label input">Link</label>
							<div class="flex fitdiv">
								{{activity.link}}
							</div>
						</div>
					</div>

					<!-- Zone -->
					<div class="item">
						<label class="label upload">Zone</label>
						<div class="flex fitdiv">
              {{zone.name.en}}
						</div>
            <zone-api
              id="zoneAPI"
              zone-id="{{activity.zone}}"
              fields="nameEN"
              page="0"
              page-size="0"
              zone="{{zone}}"
            ></zone-api>
					</div>

					<!-- Location -->
					<div class="item">
						<label class="label input">Place</label>
						<div class="" style="display: inline; word-wrap: break-word;">
              {{place.name.en}}
            </div>
            <place-api
              id="placeAPI"
              place-id="{{activity.location.place}}"
              fields="nameEN"
              page="0"
              page-size="0"
              place="{{place}}"
            ></zone-api>
          </div>

					<div class="item">
						<label class="label input">Room</label>
						<div class="flex fitdiv">
							{{room.name.en}}
						</div>
            <room-api
              id="roomAPI"
              room-id="{{activity.location.room}}"
              fields="nameEN"
              page="0"
              page-size="0"
              room="{{room}}"
            ></room-api>
					</div>

					<div class="item">
						<div>
							<label class="label input">HighLight</label>
							<div class="flex fitdiv">
                {{activity.isHighlight}}
							</div>
						</div>
					</div>

					<!-- Google Map -->
					<div class="item google-map">
						<google-map latitude="[[activity.location.latitude]]" longitude="[[activity.location.longitude]]" zoom="[[zoom]]" api-key="AIzaSyDqaDUBa0p8qYiWDwjYUlxkInJuwgTxD1o" fit>
							<google-map-marker latitude="{{activity.location.latitude}}" longitude="{{activity.location.longitude}}" draggable="false"
									title="Activity Location!" ></google-map-marker>
						</google-map>
					</div>
				</div>
				<div class="card-content">
					<!-- Thai Language -->
					<div class="flex-layout center">
						<div class="avatar" item-icon><img src="../../images/th.png" /></div>
						<div class="flex company">ภาษาไทย</div>
					</div>

					<div class="item">
						<label class="label input">ชื่อกิจกรรม</label>
						<div class="flex fitdiv">
							{{activity.name.th}}
						</div>
					</div>
					<div class="item">
						<label class="label input">รายละเอียดย่อ</label>
						<div class="flex fitdiv">
							{{activity.shortDescription.th}}
						</div>
					</div>
					<div class="item">
						<label class="label input">รายละเอียด</label>
						<div class="flex fitdiv">
							{{activity.description.th}}
						</div>
					</div>
				</div>

				<div class="card-content">
					<!-- English Language -->
					<div class="flex-layout center">
						<div class="avatar" item-icon><img src="../../images/en.png" /></div>
						<div class="flex company">English</div>
					</div>

					<div class="item">
						<label class="label input">activity name</label>
						<div class="flex fitdiv">
							{{activity.name.en}}
						</div>
					</div>
					<div class="item">
						<label class="label input">short description</label>
						<div class="flex fitdiv">
							{{activity.shortDescription.en}}
						</div>
					</div>
					<div class="item">
						<label class="label input">description</label>
						<div class="flex fitdiv">
							{{activity.description.en}}
						</div>
					</div>
				</div>

				<div class="card-content">
          <template is="dom-repeat" items="{{activity.pictures}}">
            <iron-image style="width:100px; height:100px;" sizing="cover" preload fade src="{{_computePicture(item)}}"></iron-image>
          </template>
				</div>

        <div class="card-content">
          <!-- Tags -->
          <div class="item">
            <label class="label input">Tags</label>
            <div class="flex fitdiv">
              {{activity.tags}}
            </div>
          </div>
        </div>
			</paper-card>
			<div id="right">
        <rounds-list activity-id="[[activityId]]"></rounds-list>
			</div>
			<bottom-prefab-speed-dial reveals effects="waterfall">
				<paper-fab mini icon="icons:create" on-tap="_onEdit"></paper-fab>
				<paper-fab mini icon="image:camera-alt" on-tap="_onLaunchQR"></paper-fab>
				<paper-fab mini icon="maps:local-offer" on-tap="_onActivityCheckListClick"></paper-fab>
				<paper-fab mini icon="icons:delete" on-tap=	"_onRemove"></paper-fab>
			</bottom-prefab-speed-dial>
		</div>
    <paper-dialog id="activityCheckDialog" on-iron-overlay-closed="">
      <activity-check-list id="activityCheckList" activity-id="[[activityId]]"></activity-check-list>
    </paper-dialog>
    <paper-dialog style="z-index: 150;" id="removeDialog" on-iron-overlay-closed="_onRemoveConfirm">
      <h2>Are you sure?</h2>
      <div class="buttons">
        <paper-button dialog-dismiss>No</paper-button>
        <paper-button dialog-confirm autofocus>Yes</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
    Polymer({
      is: 'activity-show-page',
      properties: {
        activityId: {
          type: String,
          observer: '_idChanged'
        },
				activated: {
					type: Boolean,
					value: false
				},
        zoom: {
          type: Number,
          value: 16
        },
        activity: {
          type: Object,
        },
        error: {
          type: Object,
        },
        deleteId: {
          type: String,
        },
      },
      observers: [
        '_activatedChanged(activated, activityId)',
      ],
      _idChanged: function(id){
        var div_qrcode = this.$.qrcode;
        if(div_qrcode){
  				div_qrcode.innerHTML = "";
  				var qrcode = new QRCode(div_qrcode, {
  					text: 'https://staff.chulaexpo.com/api/activities/' + this.activityId + "/qrcode",
  					width: 200,
  					height: 200,
  					colorDark : "#ff69B4",
  					colorLight : "#ffffff",
  					correctLevel : QRCode.CorrectLevel.L
  				});
        }

				var div_qrvideo = this.$.qrvideo;
        if(div_qrvideo) {
          div_qrvideo.innerHTML = "";
  				var qrcode = new QRCode(div_qrvideo, {
  					text: 'https://staff.chulaexpo.com/api/activities/' + this.activityId + "/qrvideo",
  					width: 200,
  					height: 200,
  					colorDark : "#000000",
  					colorLight : "#ffffff",
  					correctLevel : QRCode.CorrectLevel.L
  				});
        }

      },
      _activatedChanged: function(activated, activityId) {
				if (activated) {
					var activityRequest = this.$.activityAPI.generateRequest();
					activityRequest.completes.then(function() {
						this.$.zoneAPI.generateRequest();
						this.$.placeAPI.generateRequest();
						this.$.roomAPI.generateRequest();
					}.bind(this));
				}
      },
      _handleResponse: function(event) {
        if (event.detail.response.success) {
          this.activity = event.detail.response.results;
        } else {
          this.error = event.detail.response.errors;
        }
      },
			_onEdit: function(e) {
        window.history.pushState({}, null, '/activity/' + this.activityId + '/edit/');
        window.dispatchEvent(new CustomEvent('location-changed'));
      },
      _onLaunchQR: function(e) {
        var qr = document.createElement('qr-scanner');
        qr.url = window.api + '/api/activities/' + this.activityId + '/checkin';
        qr.open();
      },
      _onRemove: function(e) {
        this.$.removeDialog.open();
      },
      _onRemoveConfirm: function(e) {
        if(event.detail.confirmed) {
          var url = window.api + '/api/activities/' + this.activityId;
          setTimeout(function () {
            var req = new XMLHttpRequest();

            req.open('DELETE', encodeURI(url));
            req.setRequestHeader('Authorization', 'JWT ' + window.token);
            req.onload = function() {
              document.querySelector('chulaexpo-staff-app').set('route.path', '/activity/');
              window.dispatchEvent(new CustomEvent('location-changed'));
            }.bind(this);
            req.send();
          }.bind(this), 300);
        }
      },
			_onActivityCheckListClick: function(e) {
        this.$.activityCheckList.generateRequest();
        setTimeout(function() {
          this.$.activityCheckDialog.open();
        }.bind(this), 50)
			},

      _convertToDate: function(dateTime) {
        return moment.utc(dateTime).format('D MMM, HH:mm');
      },
			_computeThumbnail: function(thumbnail) {
				return thumbnail ? window.api + thumbnail : null;
			},
			_computeBanner: function(banner) {
				return banner ? window.api + banner : null;
			},
			_computePicture: function(picture) {
				return picture ? window.api + picture : null;
			},
			_computeActivityLink: function(activityId) {
				return '/activity/' + activityId ? activityId : '';
			}
    })
  </script>
</dom-module>
