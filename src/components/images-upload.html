<!-- Libery -->
<link rel="import" href="/public/lib/polymer/polymer.html">
<!-- Web Component -->
<link rel="import" href="/public/lib/iron-icon/iron-icon.html">
<link rel="import" href="/public/lib/iron-icons/iron-icons.html">
<link rel="import" href="/public/lib/iron-input-image/iron-input-image.html">
<link rel="import" href="/public/lib/iron-ajax/iron-request.html">
<link rel="import" href="/public/lib/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/public/lib/paper-tile/paper-tile.html">
<link rel="import" href="/public/lib/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="/public/lib/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="/public/lib/neon-animation/animations/scale-down-animation.html">
<link rel="import" href="/public/lib/s-circle-progress/s-circle-progress.html">

<dom-module id="images-upload">
  <template>
    <style>
      .horizontal {
        @apply(--layout);
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
      }
      .tile-loading {
        width: 100px;
        height: 100px;
        margin: 4px 8px 4px 0px;
        position: relative;
      }
      .tile-loading s-circle-progress {
        @apply(--layout-fit);
        z-index: 2;
        margin: auto;
        color: #fff;
        --s-circle-progress-bg-stroke-color: transparent;
        --s-circle-progress-stroke-color: #fff;
      }
      .tile-loading .overlay {
        @apply(--layout-fit);
        @apply(--layout-center);
        background: rgba(0, 0, 0, 0.3);
        z-index: 1;
      }
      .remove.overlay {
        opacity: 0.0;
      }
      .remove.overlay:hover {
        opacity: 1.0;
      }
      .remove.overlay iron-icon {
        padding: 38px;
        color: #dbdbdb;
      }
      .tile-loading paper-tile {
        width: 100%;
        height: 100%;
      }
      paper-tile::shadow #content {
        background: transparent;
      }
      .add-image {
        height: 100px;
        width: 100px;
        border: 1px dashed;
        border-color: #dbdbdb;
        border-radius: 3px;
        overflow: hidden;
        margin: 4px 8px 4px 0px;
        cursor: pointer;
        color: #ccc;
      }
      .add-image > a {
        @apply(--layout);
        @apply(--layout-flex);
        @apply(--layout-center);
        justify-content: center;
        width: 100%;
        height: 100%;
      }
    </style>
    <iron-request
      id="imageRequest"
      progress="{{progress}}"
    ></iron-request>
    <div class="horizontal">
      <template id="images" is="dom-repeat" items="{{images}}">
        <div class="tile-loading">
          <s-circle-progress hidden$="[[item.complete]]" value="[[item.progress]]" max="100" stroke-width="5">
            [[item.progress]]%
          </s-circle-progress>
          <div class="overlay" hidden$="[[item.complete]]"></div>
          <div class="remove overlay" on-tap="_remove">
            <iron-icon icon="icons:close"></iron-icon>
          </div>
          <paper-tile
            img="[[item.src]]"
            first-line=""
            second-line=""
          ></paper-tile>
        </div>
      </template>
      <div class="add-image">
        <a on-tap="choose">
          <iron-icon icon="icons:add"></iron-icon>
        </a>
      </div>
    </div>
    <input
      id="addImage"
      is="iron-input-image"
      src="{{src}}"
    >
  </template>
  <script>
    Polymer({
      is: 'images-upload',
      properties: {
        uploadUrl: {
          type: String
        },
        method: {
          type: String,
          value: "POST"
        },
        src: {
          type: String,
          value: '',
          observer: '_srcChanged'
        },
        images: {
          type: Array,
          value: [],
        },
        value: {
          type: Array,
          value: [],
          notify: true,
        },
        handleAs: String,
        headers: Object,
        formDataName: String,
        /*
          Animation Config
        */
        animationConfig: {
          value: function() {
            return {
              'enter': {
                name: 'fade-in-animation',
                node: this,
              },
              'exit': {
                name: 'scale-down-animation',
                node: this,
              }
            }
          }
        }
      },

      behaviors: [
        Polymer.IronFormElementBehavior,
        Polymer.NeonAnimationRunnerBehavior
      ],

      attached: function() {
        var $this = this;
        this.$$('#images').addEventListener('dom-change', function(e) {
          var element = e.target;
          var nodeList = element.querySelectorAll('.tile-loading');
          $this.animationConfig['enter'].nodes = Array.prototype.slice.call(nodeList);
          setTimeout(function() {
            $this.playAnimation('enter');
          }, 1000);
        });
      },
      _srcChanged: function(src) {
        if (this.images) {
          this.push('images', {
            src: src,
            progress: 0,
            uploadProgress: 0,
            complete: false,
          });

          var $this = this;
          var i = this.images.length - 1;
          var image = this.$.addImage.files[0];
          var xhr = new XMLHttpRequest();
          
          xhr.addEventListener('progress', function(e) {
            var done = e.position || e.loaded, total = e.totalSize || e.total;
            $this.set('images.' + i + '.progress', Math.floor(done/total*1000)/10);
          }, false);
          if ( xhr.upload ) {
            xhr.upload.onprogress = function(e) {
              var done = e.position || e.loaded, total = e.totalSize || e.total;
              $this.set('images.' + i + '.uploadProgress', Math.floor(done/total*1000)/10);
            };
          }
          xhr.onreadystatechange = function(e) {
            if ( 4 == this.readyState ) {
              $this.set('images.' + i + '.complete', true);
              $this.push('value', $this._parseResponse(xhr));
            }
          };
          xhr.open('POST', this.uploadUrl, true);
          this._parseHeader(xhr);

          var formData = new FormData();
          formData.append(this.formDataName, image);
          xhr.send(formData);
        }
      },
      _parseHeader: function(xhr) {
        var headers = this.headers || Object.create(null);
        var newHeaders = Object.create(null);
        for (var key in headers) {
          newHeaders[key.toLowerCase()] = headers[key];
        }
        headers = newHeaders;

        Object.keys(headers).forEach(function (requestHeader) {
          if (/[A-Z]/.test(requestHeader)) {
            Polymer.Base._error('Headers must be lower case, got', requestHeader);
          }
          xhr.setRequestHeader(
            requestHeader,
            headers[requestHeader]
          );
        }, this);
      },
      _parseResponse: function(xhr) {
        switch (this.handleAs) {
          case 'json':
            return JSON.parse(xhr.responseText);
            break;
          case 'text':
            return xhr.responseText;
            break;
          case 'xml':
            return xhr.responseXML;
            break;
          case 'arraybuffer':
          case 'blob':
          case 'document':
            return xhr.response;
            break;
          default: return null;
        }
      },
      _remove: function(e) {
        var tile = e.target.parentNode.parentNode.querySelector('paper-tile');
        var index = this.images.findIndex(function(img) {
          return img.src === tile.img;
        });
        this.splice('images', index, 1);
        this.splice('value', index, 1);
      },
      choose: function() {
        this.$.addImage.choose();
      },
    })
  </script>
</dom-module>