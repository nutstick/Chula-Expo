<!-- Libery -->
<link rel="import" href="/public/lib/polymer/polymer.html">
<!-- Web Component -->
<link rel="import" href="/public/lib/vaadin-upload/vaadin-upload.html">
<link rel="import" href="/public/lib/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="/public/lib/paper-card/paper-card.html">
<link rel="import" href="/public/lib/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/public/lib/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="/public/lib/paper-select/paper-select.html">
<link rel="import" href="/public/lib/paper-input/paper-textarea.html">
<link rel="import" href="/public/lib/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/public/lib/greenyouse-datetime-local-input/datetime-local-input.html">
<link rel="import" href="/public/lib/google-map/google-map.html">
<link rel="import" href="/public/lib/google-map/google-map-marker.html">

<link rel="import" href="/components/activity-api/activity-api.html">
<link rel="import" href="/components/zone-api/zone-api.html">
<link rel="import" href="/components/place-api/place-api.html">
<link rel="import" href="/components/room-api/room-api.html">

<link rel="import" href="/components/shared-styles/shared-styles.html">
<link rel="import" href="/components/images-upload/images-upload.html">


<dom-module id="activity-edit-page">
  <template>
    <style is="custom-style" include="shared-styles">
      :host {
        @apply(--layout-vertical);
        @apply(--layout-center-center);
        padding-top: 0px;
      }
      @media (min-width: 600px) {
        :host {
          padding-top: 20px;
        }
      }

      paper-card {
        width: 100%;
      }

      .item {
        @apply(--layout);
        /*@apply(--layout-horizontal);*/
        margin-bottom: 10px;
      }
      .item .input-wrapper {
      }
      .item .input-wrapper.--width {
        @apply(--layout-flex);
      }
      .avatar {
        display: inline-block;
        height: 40px;
        overflow: hidden;
        margin-right: 20px;
      }
      .label {
        font-weight: 200;
        width: 100px;
        display: inline-block;
        margin-right: 20px;

        @apply(--layout);
        flex-direction: column;
        justify-content: center;
      }
      .label.--upload {
        line-height: 70px;
      }

      .company {
        font-size: 20px;
        font-weight: 200;
      }

      .button-holder {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        margin-top: 10px;
      }

      google-map {
        display: block;
        width: 100%;
        height: 300px;
      }
      .title {
        @apply(--layout);
      }
    </style>
    <activity-api
      id="activityAPI"
			activity-id="{{activityId}}"
      headers="{{headers}}"
			fields=""
			page="0"
			page-size="0"
			activity="{{activity}}"
    ></activity-api>
    <div class="container">
      <paper-card heading="Edit Activity">
				<form
          is="iron-form"
          id="form"
          method="POST"
          class="card-content"
					action="[[_url]]"
          on-iron-form-presubmit="_presubmit"
          on-iron-form-response="_response"
          headers="[[headers]]">
					<div class="card-content">
						<!-- Thai Language -->
						<div class="title">
							<div class="avatar" item-icon><img src="/public/img/th.png" /></div>
							<div class="flex company">ภาษาไทย</div>
						</div>
            <paper-input type="text" label="ชื่อกิจกรรม" value="{{activity.name.th}}" name="nameTH" always-float-label required></paper-input>
            <paper-input type="text" label="รายละเอียดย่อ" value="{{activity.shortDescription.th}}" name="shortDescriptionTH" char-counter maxlength="80" always-float-label required></paper-input>
            <paper-textarea label="รายละเอียด" value="{{activity.description.th}}" name="descriptionTH" rows="4" always-float-label required></paper-textarea>
          </div>

					<div class="card-content">
						<!-- English Language -->
						<div class="title">
							<div class="avatar" item-icon><img src="/public/img/en.png" /></div>
							<div class="flex company">English</div>
						</div>
            <paper-input type="text" label="Activity name" value="{{activity.name.en}}" name="nameEN" always-float-label required></paper-input>
            <paper-input type="text" label="Short description" value="{{activity.shortDescription.en}}" name="shortDescriptionEN" char-counter maxlength="80" always-float-label required></paper-input>
            <paper-textarea label="Description" value="{{activity.description.en}}" name="descriptionEN" rows="4" always-float-label required></paper-textarea>
					</div>
          <div class="card-content">
            <!-- Thumbnail Upload -->
  					<div class="item">
              <label class="label --upload">Thumbnail</label>
              <div class="input-wrapper --width">
                <iron-image style="width:140px; height:80px;" sizing="cover" preload fade src="{{_computeThumbnail(activity.thumbnail)}}"></iron-image>
								<vaadin-upload
									id="thumbnailUpload"
									accept="image/*"
                  target="[[_thumbnailUploadUrl]]"
									method="POST"
                  max-files="1"
                  headers="[[headers]]"
									form-data-name="picture"
								>
									<div class="drop-label">
										<iron-icon icon="image:collections"></iron-icon>
										รูปทัมเนล
									</div>
								</vaadin-upload>
                <input id="thumbnail" type="hidden" name="thumbnail" value="">
								<script>
									var thumbnailUpload = document.querySelector('activity-edit-page').querySelector('vaadin-upload#thumbnailUpload')
									thumbnailUpload.addEventListener("upload-response", function(event) {
										if(event.detail.file.xhr.status == 200){
                      var name = JSON.parse(event.detail.xhr.responseText);
                      document.querySelector('activity-edit-page').querySelector('#thumbnail').value = name.results.thumbnail;
                    }
									});
                  thumbnailUpload.addEventListener("upload-abort", function(event) {
                    document.querySelector('activity-edit-page').querySelector('#thumbnail').value = '';
                  });
								</script>
							</div>
						</div>
  					<!-- Banner Upload -->
  					<div class="item">
							<label class="label --upload">Banner</label>
              <div class="input-wrapper --width">
                <iron-image style="width:200px; height:150px;" sizing="cover" preload fade src="{{_computeBanner(activity.banner)}}"></iron-image>
								<vaadin-upload
									id="bannerUpload"
									accept="image/*"
                  max-files="1"
                  target="[[_bannerUploadUrl]]"
									method="POST"
                  headers="[[headers]]"
									form-data-name="picture"
								>
									<div class="drop-label">
										<iron-icon icon="image:collections"></iron-icon>
										แบรนเนอร์
									</div>
								</vaadin-upload>
                <input id="banner" type="hidden" name="banner" value="">
                <script>
                  var bannerUpload = document.querySelector('activity-edit-page').querySelector('vaadin-upload#bannerUpload')
                  bannerUpload.addEventListener("upload-response", function(event) {
                    if(event.detail.file.xhr.status == 200){
                      var name = JSON.parse(event.detail.xhr.responseText);
                      document.querySelector('activity-edit-page').querySelector('#banner').value = name.results.banner;
                    }
                  });
                  bannerUpload.addEventListener("upload-abort", function(event) {
                    document.querySelector('activity-edit-page').querySelector('#banner').value = '';
                  });
                </script>
							</div>
  					</div>
  					<!-- Time -->
  					<div class="item">
  						<label class="label --input">Start Time</label>
              <div class="input-wrapper">
								<datetime-local-input name="start" label="" no-label-float="true" value="{{activity.start}}" required></datetime-local-input>
  						</div>
            </div>
						<div class="item">
							<label class="label --input">End Time</label>
              <div class="input-wrapper">
								<datetime-local-input name="end" label="" no-label-float="true" value="{{activity.end}}" required></datetime-local-input>
							</div>
  					</div>

  					<div class="item">
  						<label class="label --input">Contact</label>
              <div class="input-wrapper --width">
  							<paper-input type="text" value="{{activity.contact}}" name="contact" label="" no-label-float="true" placeholder="เบอร์ ์หรือสถานที่ติดต่อ"></paper-input>
  						</div>
  					</div>

  					<div class="item">
  						<label class="label --input">Video Url</label>
              <div class="input-wrapper">
  							<paper-input type="text" value="{{activity.video}}" name="video" label="" no-label-float="true" placeholder="www."></paper-input>
  		        </div>
  					</div>
            <div class="item">
  						<label class="label --input">PDF Url</label>
              <div class="input-wrapper">
  							<paper-input type="text" value="{{activity.pdf}}" name="pdf" label="" no-label-float="true" placeholder="www."></paper-input>
              </div>
            </div>
            <div class="item">
  						<label class="label --input">Link</label>
              <div class="input-wrapper">
  							<paper-input type="text" value="{{activity.link}}" name="link" label="" no-label-float="true" placeholder="www."></paper-input>
  						</div>
  					</div>

            <!-- Zone -->
  					<div class="item">
  						<label class="label --input">Zone</label>
  						<div class="input-wrapper">
                <vaadin-combo-box
                  name="zone"
                  items="{{zones}}"
                  id="input-zone"
                  class="elements-box"
                  no-label-float="true"
                  value="{{activity.zone}}"
                  item-label-path="name.en"
                  item-value-path="_id"
                  placeholder="เลือก zone ของกิจกรรม"
                  on-selected-item-changed="_computePlace"
                  required
                ></vaadin-combo-box>
                <zone-api
                  id="zoneAPI"
                  zones="{{zones}}"
                  error="{{error}}"
                  loading="{{zoneLoading}}"
                  page="0"
                  page-size="0"
                  fields="_id,nameEN"
                ></zone-api>
  						</div>
  					</div>

            <!-- Location -->
  					<div class="item">
              <label class="label --input">Place</label>
              <div class="input-wrapper">
                <vaadin-combo-box
                  name="locationPlace"
                  items="{{places}}"
                  id="input-place"
                  class="elements-box"
                  value="{{activity.location.place}}"
                  no-label-float="true"
                  item-label-path="name.en"
                  item-value-path="_id"
                  on-selected-item-changed="_computeRoom"
                  required
                  placeholder="เลือกสถานที่"
                ></vaadin-combo-box>
                <place-api
                  id="placeAPI"
                  places="{{places}}"
                  zone-id="{{zoneId}}"
                  error="{{error}}"
                  loading="{{placeLoading}}"
                  page="0"
                  value="{{activity.location.place}}"
                  page-size="0"
                  fields="_id,nameEN"
                ></place-api>
              </div>
  					</div>

            <div class="item">
              <label class="label --input">Room</label>
              <div class="input-wrapper">
                <vaadin-combo-box
                  name="locationRoom"
                  items="{{rooms}}"
                  id="input-room"
                  value="{{activity.location.room}}"
                  class="elements-box"
                  no-label-float="true"
                  item-label-path="name.en"
                  item-value-path="_id"
                  placeholder="เลือกห้อง"
                ></vaadin-combo-box>
                <room-api
                  id="roomAPI"
                  rooms="{{rooms}}"
                  place-id="{{placeId}}"
                  error="{{error}}"
                  loading="{{roomLoading}}"
                  page="0"
                  page-size="0"
                  fields="_id,nameEN"
                ></room-api>
              </div>
            </div>

  					<div class="item">
  						<label class="label --input">HighLight</label>
              <div class="input-wrapper">
  							<paper-checkbox name="isHighlight" label="" no-label-float="true" checked={{activity.isHighlight}}></paper-checkbox>
  						</div>
  					</div>
          </div>

          <div class="card-content">
						<!-- Picture -->
						<div class="item">
							<label class="label --height">รูปภาพที่เกี่ยวข้อง</label>
              <template is="dom-repeat" items="{{activity.pictures}}">
                <iron-image style="width:100px; height:100px;" sizing="cover" preload fade src="{{_computePicture(item)}}"></iron-image>
              </template>
							<div class="input-wrapper">
                <images-upload
                  id="pictureUpload"
                  upload-url="[[_activityUploadUrl]]"
                  headers="[[headers]]"
                  method="POST"
                  value="{{pictures}}"
                  handle-as="json"
                  form-data-name="picture"
                ></images-upload>
							</div>
						</div>
						<!-- Tags -->
						<div class="item">
              <label class="label --input">Tags</label>
              <div class="input-wrapper">
                <paper-select
                  multiple
                  label-field="tags"
                  bind-value="{{activity.tags}}"
                  select-on-blur
                  label="เลือก tags สำหรับกิจกรรม"
                  on-input-changed="inputChanged"
                ></paper-select>
              </div>
						</div>
					</div>

					<!-- Google Map -->
					<div class="item google-map">
						<google-map latitude="[[activity.location.latitude]]" longitude="[[activity.location.longitude]]" zoom="[[zoom]]" api-key="AIzaSyDqaDUBa0p8qYiWDwjYUlxkInJuwgTxD1o" fit>
							<google-map-marker latitude="{{activity.location.latitude}}" longitude="{{activity.location.longitude}}" draggable="true"
									title="Activity Location!" fit ></google-map-marker>
						</google-map>
					</div>


					<!-- Submit Button -->
					<div class="card-actions">
						<div class="button-holder">
							<paper-button on-click="_delayedSubmit">
								<paper-spinner id="spinner" hidden></paper-spinner>Save
							</paper-button>
						</div>
					</div>
				</form>
      </paper-card>
    </div>
  </template>
  <script>
    Polymer({
      is: 'activity-edit-page',
      properties: {
        activated: {
          type: Boolean,
          value: false,
          observer: '_activatedChanged'
        },
        _url: {
          type: String,
          value: function() {
            return window.api + '/api/activities';
          }
        },
        _thumbnailUploadUrl: {
          type: String,
          value: function() {
            return window.api + '/upload/img/activities/thumbnail';
          }
        },
        _bannerUploadUrl: {
          type: String,
          value: function() {
            return window.api + '/upload/img/activities/banner';
          }
        },
        _activityUploadUrl: {
          type: String,
          value: function() {
            return window.api + '/upload/img/activities/picture';
          }
        },
        zoom: {
          type: Number,
          value: 16
        },
        zoneId: {
          type: String
        },
        placeId: {
          type: String
        },
        activity: {
          type: Object,
        },
        pictures: {
          type: Set,
          value: new Set()
        },
        activityId: {
          type: String,
          observer: '_idChanged'
        },
        tags: {
          type: Array
        },
        headers: {
          type: Object,
          value: {
            'Authorization': 'JWT ' + window.token
          }
        }
      },
      inputChanged: function(e) {
        var data = ["Energy","Ageing Society","Body","Mind","Social Issues","Invention","Quality of Life","Food & Agriculture","Community","Art & Culture","Medication","Economy","Transportation","Technology","Environment","Thai Wisdom","Design","Law","Education","Royal Duties","Beauty","Life","Communication","Sport","Science","Entertainment","International Issue"];
        var input = (e.detail.value || '').trim().toLowerCase();
        if (input) {
          e.target.options = data.filter(function(item) {
            return item.toLowerCase().indexOf(input) === 0;
          });
        } else {
          e.target.options = [];
        }
      },
      _activatedChanged: function(activated) {
        if (activated) {
          this.$.activityAPI.generateRequest();
          this.$.zoneAPI.generateRequest();
          this.$.placeAPI.generateRequest();
          this.$.roomAPI.generateRequest();
        }
      },
      _delayedSubmit: function(event) {
        var form = this.$.form;
        this.$.spinner.active = true;
        this.$.spinner.hidden = false;
        this.$.form.disabled = true;
        // Simulate a slow server response.
        setTimeout(function() {
          form.submit();
        }, 1000);
      },
      _response: function(e) {
        if (e.detail.response.success) {
          this.$.form.reset();

          var list = document.querySelector('activity-show-page')
          if(typeof list.generateRequest === 'function'){
            list.generateRequest();
          }

					window.history.pushState({}, null, '/activity/' + this.activityId + '/show/');
          window.dispatchEvent(new CustomEvent('location-changed'));
        }
      },
      _presubmit: function(event) {
        this.$.form.request.method = 'PUT';
      	this.$.form.request.body.locationLat = this.activity.location.latitude;
				this.$.form.request.body.locationLong = this.activity.location.longitude;
				this.$.form.request.body.pictures = [];
        this.$.form.request.body.isHighlight = this.activity.isHighlight;
        var dom = this;
        this.pictures.forEach(function(key,value, Set) {
          dom.$.form.request.body.pictures.push(key);
        });
        if(this.$.form.request.body.thumbnail == '')
          this.$.form.request.body.thumbnail = this.activity.thumbnail;
        if(this.$.form.request.body.banner == '')
          this.$.form.request.body.banner = this.activity.banner;
        this.$.form.request.body.tags = this.activity.tags;

        for (field in this.$.form.request.body) {
          console.log(field);
          if (typeof this.$.form.request.body[field] === 'undefined') {
            delete this.$.form.request.body[field];
          }
        }

      },
      _idChanged: function(id) {
        if (id && id!='show' && id!='edit' && id!='add' && id!='list') {
          this._url = window.api + '/api/activities/' + id;
        } else {
          this._url = window.api + '/api/activities/';
        }
      },
      _computePlace: function(e) {
        if (e.detail.value) {
          this.zoneId = e.detail.value._id;
          this.$.placeAPI.generateRequest();
        }
      },
      _computeRoom: function(e) {
        if (e.detail.value) {
          this.placeId = e.detail.value._id;
          this.$.roomAPI.generateRequest();
        }
      },
			_computeThumbnail: function(thumbnail) {
				return thumbnail ? window.api + thumbnail : null;
			},
			_computeBanner: function(banner) {
				return banner ? window.api + banner : null;
			},
			_computePicture: function(picture) {
				return picture ? window.api + picture : null;
			},
    })
  </script>
</dom-module>
